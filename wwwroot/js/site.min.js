var twiliochat=function(){function rt(n){n.keyCode===13&&y()}function ut(t){t.keyCode===13?(n.currentChannel.sendMessage($(this).val()),t.preventDefault(),$(this).val("")):v()}function y(){var t=r.val();if(r.val(""),t==""){alert("Username cannot be empty");return}n.username=t;p(n.username,ft)}function p(n,t){$.ajax({url:"/home/token",method:"post",data:JSON.stringify({identity:n}),contentType:"application/json"}).done(function(n){t(n)}).fail(function(n){console.log("Failed to fetch the Access Token with error: "+n)})}function ft(t){n.messagingClient=new Twilio.Chat.Client(t);n.messagingClient.initialize().then(function(){st();n.loadChannelList(n.joinGeneralChannel);n.messagingClient.on("channelAdded",$.throttle(n.loadChannelList));n.messagingClient.on("channelRemoved",$.throttle(n.loadChannelList));n.messagingClient.on("tokenExpired",et)})}function et(){p(n.username,ot)}function ot(){n.messagingClient.updateToken(tokenResponse.token)}function st(){$("#username-span").text(n.username);o.addClass("connected").removeClass("disconnected");n.$messageList.addClass("connected").removeClass("disconnected");s.addClass("connected").removeClass("disconnected");i.addClass("with-shadow");c.addClass("connected").removeClass("disconnected")}function ht(t){return console.log("Initialized channel "+t.friendlyName),n.messagingClient.getChannelBySid(t.sid)}function ct(t){return t.join().then(function(i){return console.log("Joined channel "+i.friendlyName),at(t),n.currentChannel=t,n.loadMessages(),i})}function lt(){console.log(n.currentChannel.friendlyName+" ready.");n.currentChannel.on("messageAdded",n.addMessageToList);n.currentChannel.on("typingStarted",g);n.currentChannel.on("typingEnded",nt);n.currentChannel.on("memberJoined",b);n.currentChannel.on("memberLeft",k);i.prop("disabled",!1).focus()}function a(n){return w().then(function(){return ht(n)}).then(function(n){return ct(n)}).then(lt)}function w(){return n.currentChannel?n.currentChannel.leave().then(function(t){console.log("left "+t.friendlyName);t.removeListener("messageAdded",n.addMessageToList);t.removeListener("typingStarted",g);t.removeListener("typingEnded",nt);t.removeListener("memberJoined",b);t.removeListener("memberLeft",k)}):Promise.resolve()}function b(n){d(n.identity+" joined the channel")}function k(n){d(n.identity+" left the channel")}function d(t){var i=$("<div>").addClass("col-md-12");i.loadTemplate("#member-notification-template",{status:t});n.$messageList.append(i);tt()}function g(n){l.text(n.identity+" is typing...")}function nt(){l.text("")}function tt(){n.$messageList.scrollTop(n.$messageList[0].scrollHeight)}function at(t){var r=$(".channel-element").toArray(),i=r.filter(function(n){return $(n).data().sid===t.sid});i=$(i);n.currentChannelContainer===undefined&&t.uniqueName===f&&(n.currentChannelContainer=i);n.currentChannelContainer.removeClass("selected-channel").addClass("unselected-channel");i.removeClass("unselected-channel").addClass("selected-channel");n.currentChannelContainer=i}function vt(){n.messagingClient&&(h.addClass("showing").removeClass("not-showing"),t.addClass("showing").removeClass("not-showing"),u.focus())}function yt(){h.addClass("not-showing").removeClass("showing");t.addClass("not-showing").removeClass("showing");u.val("")}function pt(i){var r,u;i.uniqueName===f&&(n.generalChannel=i);r=$("<div>").addClass("row channel-row");r.loadTemplate("#channel-template",{channelName:i.friendlyName});u=r.children().children().first();r.on("click",bt);u.data("sid",i.sid);n.currentChannel&&i.sid===n.currentChannel.sid?(n.currentChannelContainer=u,u.addClass("selected-channel")):u.addClass("unselected-channel");t.append(r)}function wt(){if(n.currentChannel){if(n.currentChannel.sid===n.generalChannel.sid){alert("You cannot delete the general channel");return}n.currentChannel.delete().then(function(t){console.log("channel: "+t.friendlyName+" deleted");a(n.generalChannel)})}}function bt(t){var r=$(t.target),u=r.data().sid,i=n.channelArray.filter(function(n){return n.sid===u})[0];i!==n.currentChannel&&a(i)}function kt(){w();t.text("");n.$messageList.text("");channels=undefined;o.addClass("disconnected").removeClass("connected");n.$messageList.addClass("disconnected").removeClass("connected");s.addClass("disconnected").removeClass("connected");i.removeClass("with-shadow");c.addClass("disconnected").removeClass("connected")}var n={},v;console.log("Start script");var f="general",e="General Channel",it=50,t,i,r,o,s,h,u,c,l;return $(document).ready(function(){n.init()}),n.init=function(){n.$messageList=$("#message-list");t=$("#channel-list");i=$("#input-text");r=$("#username-input");o=$("#status-row");s=$("#connect-panel");h=$("#new-channel-input-row");u=$("#new-channel-input");c=$("#typing-row");l=$("#typing-placeholder");r.focus();r.on("keypress",rt);i.on("keypress",ut);u.on("keypress",n.handleNewChannelInputKeypress);$("#connect-image").on("click",y);$("#add-channel-image").on("click",vt);$("#leave-span").on("click",kt);$("#delete-channel-span").on("click",wt)},v=$.throttle(function(){n.currentChannel.typing()},1e3),n.handleNewChannelInputKeypress=function(t){t.keyCode===13&&(n.messagingClient.createChannel({friendlyName:u.val()}).then(yt),$(this).val(""),t.preventDefault())},n.loadChannelList=function(i){if(n.messagingClient===undefined){console.log("Client is not initialized");return}n.messagingClient.getPublicChannels().then(function(r){n.channelArray=n.sortChannelsByName(r.items);t.text("");n.channelArray.forEach(pt);typeof i=="function"&&i()})},n.joinGeneralChannel=function(){console.log('Attempting to join "general" chat channel...');n.generalChannel?(console.log("Found general channel:"),a(n.generalChannel)):n.messagingClient.createChannel({uniqueName:f,friendlyName:e}).then(function(t){console.log("Created general channel");n.generalChannel=t;n.loadChannelList(n.joinGeneralChannel)})},n.loadMessages=function(){n.currentChannel.getMessages(it).then(function(t){t.items.forEach(n.addMessageToList)})},n.addMessageToList=function(t){var i=$("<div>").addClass("row no-margin");i.loadTemplate($("#message-template"),{username:t.author,date:dateFormatter.getTodayDate(t.timestamp),body:t.body});t.author===n.username&&i.addClass("own-message");n.$messageList.append(i);tt()},n.sortChannelsByName=function(n){return n.sort(function(n,t){return n.friendlyName===e?-1:t.friendlyName===e?1:n.friendlyName.localeCompare(t.friendlyName)})},n}();
//# sourceMappingURL=site.min.js.map